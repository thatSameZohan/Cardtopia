# Архитектура WebSocket на Фронтенде (React)

Этот документ описывает, как клиентская часть нашего приложения взаимодействует с WebSocket-сервером через STOMP.

## 1. Основные библиотеки

- **`sockjs-client`**: Используется для установки WebSocket-соединения. Эта библиотека предоставляет фолбэк (альтернативные способы подключения) для старых браузеров, которые не поддерживают WebSocket нативно.
- **`@stomp/stompjs`**: Основная библиотека для работы с протоколом STOMP. Она позволяет нам отправлять и получать сообщения, а также управлять подписками на "топики".

## 2. Логика подключения (`Lobby.tsx`)

Вся логика инкапсулирована в компоненте `Lobby.tsx`.

### 2.1. Инициализация клиента

- В `useEffect` с пустым массивом зависимостей `[]` (чтобы выполниться один раз при монтировании компонента) мы создаем новый экземпляр `Client` из `@stomp/stompjs`.
- В конструктор мы передаем `webSocketFactory`, который указывает, как создавать базовое соединение. Мы используем `() => new SockJS(WS_URL)`, где `WS_URL` — это `http://localhost:8080/ws`.
- Мы также настраиваем `onConnect` — это колбэк, который выполнится после успешной установки соединения.

### 2.2. Управление подписками

- **Внутри `onConnect`**: Сразу после подключения мы подписываемся на ключевые топики.
    - `stompClient.subscribe("/topic/rooms", callback)`: Мы подписываемся на обновления списка комнат. Когда приходит сообщение, мы парсим его тело (`JSON.parse(msg.body)`) и обновляем состояние `rooms` с помощью `setRooms()`.
- **Внутри `useEffect` с зависимостью `[currentRoom]`**:
    - Когда пользователь входит в комнату (т.е. `currentRoom` меняется), мы создаем две новые подписки:
        1.  На `/topic/room/{currentRoom.id}/players` для получения списка игроков в этой комнате.
        2.  На `/topic/room/{currentRoom.id}/state` для получения состояния игры (здоровье и т.д.).
    - Важно, что этот `useEffect` возвращает функцию очистки, в которой мы вызываем `unsubscribe()` для этих подписок. Это предотвращает утечки памяти и получение сообщений из комнат, которые мы уже покинули.

## 3. Поток данных (Data Flow)

### 3.1. Загрузка страницы (Лобби)

1.  Компонент `Lobby` монтируется. `useEffect` запускается.
2.  Создается и активируется STOMP-клиент.
3.  Происходит подключение к `http://localhost:8080/ws`.
4.  Срабатывает `onConnect`. Клиент подписывается на `/topic/rooms`.
5.  **Бэкенд**, благодаря `@SubscribeMapping`, видит эту подписку и **немедленно** присылает текущий список комнат.
6.  Клиент получает это сообщение, парсит его и обновляет `setRooms()`, что вызывает перерисовку интерфейса и отображение списка комнат.

### 3.2. Вход в комнату и начало игры

1.  Пользователь нажимает "Войти" у комнаты.
2.  Вызывается `handleJoinRoom(roomId)`.
3.  Мы **не подписываемся** на топик комнаты сразу. Мы просто отправляем серверу намерение присоединиться: `client.publish({ destination: "/app/rooms/join", ... })`.
4.  Одновременно мы устанавливаем `setCurrentRoom(room)`, что вызывает срабатывание второго `useEffect`.
5.  **Вот теперь**, когда `currentRoom` установлен, `useEffect` создает подписки на `/topic/room/{roomId}/players` и `/topic/room/{roomId}/state`.
6.  Когда второй игрок присоединяется, **бэкенд** отправляет `GameState` в топик `/topic/room/{roomId}/state`.
7.  **Оба клиента**, уже подписанные на этот топик, получают `GameState`.
8.  Срабатывает колбэк подписки, вызывается `setGameState(gameState)`.
9.  Состояние `gameState` перестает быть `null`, и React отображает условный рендеринг — здоровье игроков и кнопки "Атака".

### 3.3. Игровое действие (Атака)

1.  Игрок нажимает кнопку "Атаковать".
2.  Вызывается `handlePlayerAction(targetId)`.
3.  Создается объект `action` с ID цели и силой атаки.
4.  `client.publish({ destination: "/app/room/{roomId}/action", body: JSON.stringify(action) })` отправляет действие на сервер.
5.  Сервер обрабатывает действие и присылает **всем** в комнате обновленный `GameState`.
6.  Клиент получает новый `GameState` в своей подписке на `/topic/room/{roomId}/state`, вызывает `setGameState()`, и интерфейс перерисовывается с новым значением здоровья.