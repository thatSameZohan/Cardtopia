<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>WebSocket Chat</title>

    <link rel="stylesheet"
          href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <style>
        body { padding-top: 1.5rem }
        #conversation { margin-top: 1rem }
        #statusBadge { min-width: 120px }
        .log-box {
            height: 180px;
            overflow: auto;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: .5rem;
            font-size: 13px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="row align-items-center">
        <div class="col-md-6">
            <h4>WebSocket Chat</h4>
            <p class="mb-1">Endpoint: <code>/ws</code></p>
        </div>
        <div class="col-md-6 text-md-right">
            <span id="statusBadge" class="badge badge-secondary">Disconnected</span>
        </div>
    </div>

    <div class="card mt-3">
        <div class="card-body">

            <form class="form-inline mb-3" onsubmit="return false;">
                <button id="connect" class="btn btn-primary mr-2" type="button">Connect</button>
                <button id="disconnect" class="btn btn-outline-danger mr-4" type="button" disabled>Disconnect</button>

                <input type="text" id="message" class="form-control mr-2 flex-grow-1" placeholder="Your message...">
                <button id="send" class="btn btn-success" type="button">Send</button>
            </form>

            <div class="row">
                <div class="col-md-8">
                    <table id="conversation" class="table table-sm table-striped">
                        <thead>
                        <tr><th style="width: 90px">Time</th><th>Message</th></tr>
                        </thead>
                        <tbody id="messages"></tbody>
                    </table>
                </div>
                <div class="col-md-4">
                    <h6>Logs</h6>
                    <div id="log" class="log-box"></div>
                </div>
            </div>

        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7/bundles/stomp.umd.min.js"></script>

<script>
    let stompClient = null;

    function log(msg) {
        const now = new Date().toLocaleTimeString();
        $('#log').append($('<div>').text(now + " — " + msg));
        $('#log').scrollTop($('#log')[0].scrollHeight);
    }

    function setConnected(connected) {
        $("#connect").prop("disabled", connected);
        $("#disconnect").prop("disabled", !connected);
        $("#statusBadge").removeClass().addClass("badge " + (connected ? "badge-success" : "badge-secondary"))
            .text(connected ? "Connected" : "Disconnected");
        if (!connected) $("#messages").empty();
    }

    function getToken() {
        const token = localStorage.getItem("accessToken");
        if (!token) {
            alert("Access token not found. Redirecting to login...");
            window.location.href = "/test/login";
        }
        return token;
    }

    function connect() {
        const auth = getToken();
        log("Connecting with JWT...");
        const socket = new SockJS("/ws");

        stompClient = new StompJs.Client({
            webSocketFactory: () => socket,
            connectHeaders: { Authorization: "Bearer " + auth },
            reconnectDelay: 5000,
            debug: msg => log("[STOMP] " + msg),
            onConnect: frame => {
                log("Connected");
                setConnected(true);

                stompClient.subscribe("/topic/chat", msg => {
                    const body = JSON.parse(msg.body);
                    showMessage(body);
                });
            },
            onStompError: frame => {
                log("STOMP ERROR: " + frame.headers["message"]);
            }
        });

        stompClient.activate();
    }

    function disconnect() {
        if (stompClient) {
            stompClient.deactivate();
            log("Disconnected");
        }
        setConnected(false);
    }

    function sendMessage() {
        if (!stompClient || !stompClient.connected) { log("Not connected"); return; }
        const text = $("#message").val().trim();
        if (!text) return;
        stompClient.publish({ destination: "/app/chat", body: JSON.stringify({ text }) });
        $("#message").val("");
    }

    function showMessage(msg) {
        const time = new Date().toLocaleTimeString();
        $("#messages").append(`<tr><td>${time}</td><td>${msg.sender}: ${msg.text}</td></tr>`);
    }

    $(function () {
        $("#connect").click(connect);
        $("#disconnect").click(disconnect);
        $("#send").click(sendMessage);
        connect(); // автоподключение при загрузке
    });
</script>
</body>
</html>
