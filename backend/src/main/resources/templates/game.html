<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Game WebSocket Test (JWT)</title>

    <!-- SockJS & STOMP -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7/bundles/stomp.umd.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        input, button { padding: 6px; margin: 4px 0; width: 100%; }
        #log { border: 1px solid #ccc; height: 300px; overflow: auto; padding: 10px; margin-top: 10px; }
        .ok { color: green; }
        .err { color: red; }
    </style>
</head>
<body>

<h3>Game WebSocket Test (JWT)</h3>

<label>Access Token (JWT)</label>
<textarea id="token" rows="3" placeholder="Bearer ..."></textarea>

<input type="text" id="roomId" placeholder="Room ID">
<input type="text" id="cardId" placeholder="Card ID (для playCard)">
<input type="text" id="marketCardId" placeholder="Market Card ID (для buyCard)">

<button onclick="connect()">Connect</button>
<button onclick="disconnect()">Disconnect</button>
<hr>

<button onclick="playCard()">Play Card</button>
<button onclick="buyCard()">Buy Card</button>
<button onclick="attack()">Attack</button>
<button onclick="endTurn()">End Turn</button>

<h4>Logs & Room State</h4>
<div id="log"></div>

<script>
    let client = null;
    let subscribedRooms = {};

    function log(msg, type="") {
        const div = document.createElement("div");
        div.className = type;
        div.innerText = new Date().toLocaleTimeString() + " — " + msg;
        document.getElementById("log").appendChild(div);
        document.getElementById("log").scrollTop = document.getElementById("log").scrollHeight;
    }

    function connect() {
        const token = document.getElementById("token").value.trim();
        if (!token) { log("Access token is empty", "err"); return; }

        const socket = new SockJS("http://localhost:8080/ws");

        client = new StompJs.Client({
            webSocketFactory: () => socket,
            connectHeaders: { Authorization: token.startsWith("Bearer ") ? token : "Bearer " + token },
            debug: msg => log("[STOMP] " + msg),
            onConnect: frame => {
                log("Connected", "ok");

                // подписка на ошибки
                client.subscribe("/user/queue/errors", msg => log("ERROR: " + msg.body, "err"));
            },
            onStompError: frame => log("STOMP ERROR: " + frame.headers["message"], "err"),
            onWebSocketError: err => log("WebSocket error", "err")
        });

        client.activate();
    }

    function subscribeRoom(roomId) {
        if (!subscribedRooms[roomId]) {
            client.subscribe("/user/queue/room." + roomId + ".state", msg => {
                const gs = JSON.parse(msg.body);
                log("ROOM STATE: " + JSON.stringify(gs), "ok");
            });
            subscribedRooms[roomId] = true;
        }
    }

    function disconnect() {
        if (client) { client.deactivate(); log("Disconnected"); subscribedRooms = {}; }
    }

    function playCard() {
        const roomId = document.getElementById("roomId").value.trim();
        const cardId = document.getElementById("cardId").value.trim();
        if (!client || !client.connected) { log("Not connected", "err"); return; }
        if (!roomId || !cardId) { log("roomId and cardId required", "err"); return; }

        subscribeRoom(roomId);

        client.publish({
            destination: "/app/game.playCard",
            body: JSON.stringify({ roomId: roomId, cardId: cardId })
        });
        log("Sent playCard: " + JSON.stringify({roomId, cardId}));
    }

    function buyCard() {
        const roomId = document.getElementById("roomId").value.trim();
        const marketCardId = document.getElementById("marketCardId").value.trim();
        if (!client || !client.connected) { log("Not connected", "err"); return; }
        if (!roomId || !marketCardId) { log("roomId and marketCardId required", "err"); return; }

        subscribeRoom(roomId);

        client.publish({
            destination: "/app/game.buyCard",
            body: JSON.stringify({ roomId: roomId, marketCardId: marketCardId })
        });
        log("Sent buyCard: " + JSON.stringify({roomId, marketCardId}));
    }

    function attack() {
        const roomId = document.getElementById("roomId").value.trim();
        if (!client || !client.connected) { log("Not connected", "err"); return; }
        if (!roomId) { log("roomId required", "err"); return; }

        subscribeRoom(roomId);

        client.publish({
            destination: "/app/game.attack",
            body: JSON.stringify({ roomId: roomId })
        });
        log("Sent attack: " + JSON.stringify({roomId}));
    }

    function endTurn() {
        const roomId = document.getElementById("roomId").value.trim();
        if (!client || !client.connected) { log("Not connected", "err"); return; }
        if (!roomId) { log("roomId required", "err"); return; }

        subscribeRoom(roomId);

        client.publish({
            destination: "/app/game.endTurn",
            body: JSON.stringify({ roomId: roomId })
        });
        log("Sent endTurn: " + JSON.stringify({roomId}));
    }
</script>

</body>
</html>
