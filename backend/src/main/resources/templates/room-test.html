<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Rooms</title>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7/bundles/stomp.umd.min.js"></script>

    <style>
        body { font-family: Arial; padding: 20px }
        .room { border: 1px solid #ccc; padding: 8px; margin: 6px 0 }
        button { margin-right: 5px }
    </style>
</head>
<body>

<h3>Rooms</h3>

<button onclick="createRoom()">Create room</button>

<div id="rooms"></div>

<script>
    const token = localStorage.getItem("accessToken");
    if (!token) alert("Нет accessToken");

    const client = new StompJs.Client({
        webSocketFactory: () => new SockJS("http://localhost:8080/ws"),
        connectHeaders: { Authorization: "Bearer " + token },
        onConnect: () => {
            client.subscribe("/topic/rooms", msg => renderRooms(JSON.parse(msg.body)));

            client.subscribe("/user/queue/errors", msg => alert(msg.body));

            client.subscribe("/topic/game.start", () => {}); // заглушка

            client.publish({ destination: "/app/room.list" });
        }
    });

    client.activate();

    function renderRooms(rooms) {
        const div = document.getElementById("rooms");
        div.innerHTML = "";

        rooms.forEach(r => {
            const d = document.createElement("div");
            d.className = "room";
            d.innerHTML = `
                <b>${r.name}</b><br>
                Players: ${r.players.join(", ")}<br>
                <button onclick="join('${r.id}')">Join</button>
                <button onclick="leave('${r.id}')">Leave</button>
                <button onclick="del('${r.id}')">Delete</button>
                <button onclick="start('${r.id}')">Start</button>
            `;
            div.appendChild(d);

            client.subscribe("/topic/game.start." + r.id, msg => {
                const data = JSON.parse(msg.body);
                localStorage.setItem("gameId", data.gameId);
                localStorage.setItem("roomId", r.id);
                window.location.href = "/test/game";
            });
        });
    }

    function createRoom() {
        client.publish({ destination: "/app/room.create" });
    }

    function join(id) {
        localStorage.setItem("roomId", id);
        client.publish({
            destination: "/app/room.join",
            body: JSON.stringify({ roomId: id })
        });
    }

    function leave(id) {
        client.publish({
            destination: "/app/room.leave",
            body: JSON.stringify({ roomId: id })
        });
    }

    function del(id) {
        client.publish({
            destination: "/app/room.delete",
            body: JSON.stringify({ roomId: id })
        });
    }

    function start(id) {
        client.publish({
            destination: "/app/game.start",
            body: JSON.stringify({ roomId: id })
        });
    }
</script>

</body>
</html>
