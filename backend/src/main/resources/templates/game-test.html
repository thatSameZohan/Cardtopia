<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Game Test</title>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7/bundles/stomp.umd.min.js"></script>

    <style>
        body { font-family: Arial; padding: 20px }
        .active { background: #e6ffe6 }
        .card { border: 1px solid #aaa; padding: 6px; margin: 4px }
        .game-over { color: red; font-weight: bold; font-size: 18px }
        button:disabled { opacity: 0.4 }
    </style>
</head>
<body>

<h3>Game</h3>

<div id="status"></div>

<button id="attackBtn" onclick="attack()">Attack</button>
<button id="endTurnBtn" onclick="endTurn()">End turn</button>

<h4>Players</h4>
<ul id="players"></ul>

<h4>Your stats</h4>
<div id="youStats"></div>

<h4>Your hand</h4>
<div id="hand"></div>

<h4>Market</h4>
<div id="market"></div>

<script>
    const gameId = localStorage.getItem("gameId");
    const token = localStorage.getItem("accessToken");

    if (!gameId) {
        alert("Нет gameId");
        throw "";
    }

    const client = new StompJs.Client({
        webSocketFactory: () => new SockJS("http://localhost:8080/ws"),
        connectHeaders: { Authorization: "Bearer " + token },
        onConnect: () => {
            client.subscribe("/user/queue/game." + gameId, msg => {
                render(JSON.parse(msg.body));
            });

            client.subscribe("/user/queue/errors", msg => {
                console.log("ERROR:", msg.body);
            });

            client.publish({
                destination: "/app/game.init",
                body: JSON.stringify({ gameId })
            });
        }
    });

    client.activate();

    function render(gs) {
        renderStatus(gs);
        renderPlayers(gs);
        renderYou(gs);
        renderHand(gs);
        renderMarket(gs);
        toggleControls(gs.status);
    }

    function renderStatus(gs) {
        const div = document.getElementById("status");
        if (gs.status === "FINISHED") {
            div.innerHTML = `<div class="game-over">
                GAME OVER<br>
                Winner: ${gs.winnerId ?? "unknown"}
            </div>`;
        } else {
            div.innerText = `Active player: ${gs.activePlayerId}`;
        }
    }

    function renderPlayers(gs) {
        const ul = document.getElementById("players");
        ul.innerHTML = "";
        gs.players.forEach(p => {
            const li = document.createElement("li");
            li.className = p.active ? "active" : "";
            li.textContent =
                `${p.playerId} | HP:${p.health} | Hand:${p.handSize} | Deck:${p.deckSize} | ` +
                `Discard:${p.discardSize} | ATK:${p.currentAttack} | GOLD:${p.currentGold}`;
            ul.appendChild(li);
        });
    }

    function renderYou(gs) {
        const div = document.getElementById("youStats");
        if (!gs.you) {
            div.innerText = "";
            return;
        }
        div.innerText = `Your hand: ${gs.you.hand.length} cards`;
    }

    function renderHand(gs) {
        const div = document.getElementById("hand");
        div.innerHTML = "";
        if (!gs.you) return;

        gs.you.hand.forEach(c => {
            const d = document.createElement("div");
            d.className = "card";
            d.innerHTML = `
                ${c.name} (ATK:${c.attack}, GOLD:${c.gold})
                <button onclick="play('${c.id}')">Play</button>
            `;
            div.appendChild(d);
        });
    }

    function renderMarket(gs) {
        const div = document.getElementById("market");
        div.innerHTML = "";
        gs.market.forEach(c => {
            const d = document.createElement("div");
            d.className = "card";
            d.innerHTML = `
                ${c.name} COST:${c.cost}
                <button onclick="buy('${c.id}')">Buy</button>
            `;
            div.appendChild(d);
        });
    }

    function toggleControls(status) {
        const disabled = status === "FINISHED";
        document.getElementById("attackBtn").disabled = disabled;
        document.getElementById("endTurnBtn").disabled = disabled;
    }

    function play(id) {
        client.publish({
            destination: "/app/game.playCard",
            body: JSON.stringify({ gameId, cardId: id })
        });
    }

    function buy(id) {
        client.publish({
            destination: "/app/game.buyCard",
            body: JSON.stringify({ gameId, marketCardId: id })
        });
    }

    function attack() {
        client.publish({
            destination: "/app/game.attack",
            body: JSON.stringify({ gameId })
        });
    }

    function endTurn() {
        client.publish({
            destination: "/app/game.endTurn",
            body: JSON.stringify({ gameId })
        });
    }
</script>

</body>
</html>
