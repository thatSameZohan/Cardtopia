<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Game Test</title>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7/bundles/stomp.umd.min.js"></script>

    <style>
        body { font-family: Arial; padding: 20px }
        .active { background: #e6ffe6 }
        .card { border: 1px solid #aaa; padding: 6px; margin: 6px }
        .winner { color: green; font-weight: bold }
        .effect { font-size: 12px; color: #444; margin-left: 10px }
        .scrap { color: #900 }
        .error {
            background: #ffe6e6;
            color: #900;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #d00;
        }
        .explorer { background: #f5f5ff }
        .structure { background: #f0fff0 }
        .outpost { background: #fff0f0 }
        button { margin-top: 4px }
    </style>
</head>
<body>

<h3>Game</h3>

<div id="errors"></div>
<div id="status"></div>

<button onclick="attackPlayer()">Attack player</button>
<button onclick="endTurn()">End turn</button>

<h4>Players</h4>
<div id="players"></div>

<h4>Your hand</h4>
<div id="hand"></div>

<h4>Played cards</h4>
<div id="played"></div>

<h4>Market</h4>
<div id="market"></div>

<h4>Explorer pile</h4>
<div id="explorer"></div>

<script>
    const gameId = localStorage.getItem("gameId");
    const token = localStorage.getItem("accessToken");

    let gameView = null;
    let privateView = null;

    const client = new StompJs.Client({
        webSocketFactory: () => new SockJS("http://localhost:8080/ws"),
        connectHeaders: { Authorization: "Bearer " + token },

        onConnect: () => {
            client.subscribe("/topic/game." + gameId, msg => {
                gameView = JSON.parse(msg.body);
                render();
            });

            client.subscribe("/user/queue/game." + gameId, msg => {
                privateView = JSON.parse(msg.body);
                render();
            });

            client.subscribe("/user/queue/errors", msg => {
                const err = JSON.parse(msg.body);
                showError(err.code + ": " + err.message);
            });

            client.publish({
                destination: "/app/game.init",
                body: JSON.stringify({ gameId })
            });
        }
    });

    client.activate();

    function showError(text) {
        const div = document.getElementById("errors");
        div.innerHTML = `<div class="error">${text}</div>`;
        setTimeout(() => div.innerHTML = "", 4000);
    }

    function render() {
        if (!gameView) return;
        renderStatus();
        renderPlayers();
        renderMarket();
        renderExplorer();
        if (privateView) {
            renderHand();
            renderPlayed();
        }
    }

    function renderStatus() {
        document.getElementById("status").innerHTML = `
        Status: ${gameView.status}
        ${gameView.winnerId ? `<div class="winner">Winner: ${gameView.winnerId}</div>` : ""}
    `;
    }

    function renderPlayers() {
        const div = document.getElementById("players");
        div.innerHTML = "";

        gameView.players.forEach(p => {
            const d = document.createElement("div");
            d.className = p.active ? "active" : "";

            d.innerHTML = `
            <strong>${p.playerId}</strong>
            | HP:${p.health} | ATK:${p.currentAttack} | GOLD:${p.currentGold}
            <div>
                <strong>Bases</strong>
                ${p.bases.map(b => renderStructure(b, "BASE")).join("")}
            </div>
            <div>
                <strong>Outposts</strong>
                ${p.outposts.map(o => renderStructure(o, "OUTPOST")).join("")}
            </div>
        `;
            div.appendChild(d);
        });
    }

    function renderStructure(c, type) {
        const def = c.definition;
        const canScrap = def.scrapEffects && def.scrapEffects.effects.length > 0;

        return `
        <div class="card ${type === 'OUTPOST' ? 'outpost' : 'structure'}">
            <strong>${def.name}</strong>
                <div>Type: ${def.type}</div>
                <div>Faction: ${def.faction}</div>
                <div>Def: ${def.defense}</div>
            ${renderEffects("Main", def.mainEffects)}
            ${renderEffects("Faction", def.factionEffectsLvl1)}
            ${renderEffects("Scrap", def.scrapEffects)}
            <button onclick="attackStructure('${type}', '${c.id}')">Attack</button>
            ${canScrap ? `<button onclick="scrapStructure('${c.id}')">Scrap</button>` : ""}
        </div>
    `;
    }

    function renderEffects(title, set, cls = "") {
        if (!set || !set.effects || set.effects.length === 0) return "";
        return `
        <div class="effect ${cls}">
            <strong>${title}</strong>
            ${set.effects.map(e => `â€¢ ${e.type} +${e.value}`).join(", ")}
            type: ${set.type}
        </div>
    `;
    }


    function renderHand() {
        const div = document.getElementById("hand");
        div.innerHTML = "";

        privateView.hand.forEach(c => {
            const def = c.definition;

            const hasScrap =
                def.scrapEffects &&
                def.scrapEffects.effects &&
                def.scrapEffects.effects.length > 0;

            const checkboxId = `scrap-${c.id}`;

            const d = document.createElement("div");
            d.className = "card";

            d.innerHTML = `
            <strong>${def.name}</strong>
            <div>Type: ${def.type}</div>
            <div>Faction: ${def.faction}</div>
            ${renderEffects("Main", def.mainEffects)}
            ${renderEffects("Faction Lvl1", def.factionEffectsLvl1)}
            ${renderEffects("Scrap", def.scrapEffects, "scrap")}

            ${hasScrap ? `
                <label>
                    <input type="checkbox" id="${checkboxId}">
                    Scrap
                </label>
            ` : ""}

            <button onclick="play('${c.id}', ${hasScrap})">Play</button>
        `;

            div.appendChild(d);
        });
    }

    function renderPlayed() {
        const div = document.getElementById("playedCards");
        div.innerHTML = "";
        privateView.playedCards?.forEach(c => {
            div.innerHTML += `<div class="card">${c.definition.name}</div>`;
        });
    }

    function renderMarket() {
        const div = document.getElementById("market");
        div.innerHTML = "";

        gameView.market.forEach(c => {
            const def = c.definition;
            div.innerHTML += `
            <div class="card">
                <strong>${def.name}</strong>
                <div>Type: ${def.type}</div>
                <div>Faction: ${def.faction}</div>
                <div>Cost: ${def.cost}</div>
                ${renderEffects("Main", def.mainEffects)}
                ${renderEffects("Faction", def.factionEffectsLvl1)}
                ${renderEffects("Scrap", def.scrapEffects)}
                <button onclick="buy('${c.id}')">Buy</button>
            </div>
        `;
        });
    }

    function renderExplorer() {
        const div = document.getElementById("explorer");
        div.innerHTML = "";

        if (!gameView.explorerPile.length) {
            div.innerHTML = "<i>Explorer pile empty</i>";
            return;
        }

        const c = gameView.explorerPile[0];
        const def = c.definition;

        div.innerHTML = `
        <div class="card explorer">
            <strong>${def.name}</strong> (cost:${def.cost})
            ${renderEffects("Main", def.mainEffects)}
            ${renderEffects("Scrap", def.scrapEffects)}
            <div class="effect">Cards left: ${gameView.explorerPile.length}</div>
            <button onclick="buy('${c.id}')">Buy</button>
        </div>
    `;
    }

    /* ========= ACTIONS ========= */

    function play(cardId, hasScrap) {
        let scrap = false;

        if (hasScrap) {
            const checkbox = document.getElementById("scrap-" + cardId);
            scrap = checkbox && checkbox.checked;
        }

        client.publish({
            destination: "/app/game.playCard",
            body: JSON.stringify({ gameId, cardId, scrap })
        });
    }


    function buy(cardId) {
        client.publish({
            destination: "/app/game.buyCard",
            body: JSON.stringify({ gameId, marketCardId: cardId })
        });
    }

    function attackStructure(type, id) {
        client.publish({
            destination: "/app/game.attack",
            body: JSON.stringify({
                gameId,
                targetType: type,
                targetId: id
            })
        });
    }

    function attackPlayer() {
        client.publish({
            destination: "/app/game.attack",
            body: JSON.stringify({
                gameId,
                targetType: "PLAYER"
            })
        });
    }

    function scrapStructure(cardId) {
        client.publish({
            destination: "/app/game.scrapStructure",
            body: JSON.stringify({ gameId, cardId })
        });
    }

    function endTurn() {
        client.publish({
            destination: "/app/game.endTurn",
            body: JSON.stringify({ gameId })
        });
    }
</script>

</body>
</html>
