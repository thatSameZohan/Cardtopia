<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Game Test</title>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7/bundles/stomp.umd.min.js"></script>

    <style>
        body { font-family: Arial; padding: 20px }
        .card { border: 1px solid #aaa; padding: 6px; margin: 6px }
        .active { background: #e6ffe6 }
        .effect { font-size: 12px; color: #444 }
        .error { background:#ffe6e6;color:#900;padding:8px;margin-bottom:10px }
        button { margin: 4px 0 }
    </style>
</head>
<body>

<h2>Game Test</h2>

<div id="errors"></div>
<div id="status"></div>

<button onclick="attackPlayer()">Attack player</button>
<button onclick="endTurn()">End turn</button>

<h3>Players</h3>
<div id="players"></div>

<h3>Your hand</h3>
<div id="hand"></div>

<h3>Played cards</h3>
<div id="played"></div>

<h3>Market</h3>
<div id="market"></div>

<h3>Explorers</h3>
<div id="explorers"></div>

<script>
    const gameId = localStorage.getItem("gameId");
    const token = localStorage.getItem("accessToken");

    let gameView = null;
    let privateView = null;

    const client = new StompJs.Client({
        webSocketFactory: () => new SockJS("http://localhost:8080/ws"),
        connectHeaders: { Authorization: "Bearer " + token },

        onConnect: () => {
            client.subscribe("/topic/game." + gameId, m => {
                gameView = JSON.parse(m.body);
                render();
            });

            client.subscribe("/user/queue/game." + gameId, m => {
                privateView = JSON.parse(m.body);
                render();
            });

            client.subscribe("/user/queue/errors", m => {
                const e = JSON.parse(m.body);
                showError(e.code + ": " + e.message);
            });

            client.publish({
                destination: "/app/game.init",
                body: JSON.stringify({ gameId })
            });
        }
    });
    client.activate();

    /* ===== RENDER ===== */

    function render() {
        if (!gameView) return;
        renderStatus();
        renderPlayers();
        if (privateView) {
            renderHand();
            renderPlayed();
        }
        renderMarket();
        renderExplorers();
    }

    function cardView(c) {
        return `
    <div class="card">
        <b>${c.name}</b>

        <div class="effect">
            type: ${c.type}
            | faction: ${c.faction}
            | <b>cost: ${c.cost ?? "-"}</b>
            ${c.defense > 0 ? `| defense: ${c.defense}` : ""}
        </div>

        ${renderSetEffects("Main", c.mainEffects)}
        ${renderSetEffects("Faction", c.factionEffectsLvl1)}
        ${renderSetEffects("Scrap", c.scrapEffects)}
    </div>`;
    }

    function structureView(c, ownerPlayer) {
        const hasScrap =
            c.scrapEffects &&
            c.scrapEffects.effects &&
            c.scrapEffects.effects.length > 0;

        const activePlayer = gameView.players.find(p => p.active);

        const canDestroyBase =
            c.type === "BASE" &&
            activePlayer &&
            activePlayer.destroyBase > 0;

        return `
    <div class="card">
        <b>${c.name}</b>
        <div class="effect">
            type:${c.type} faction:${c.faction} defense:${c.defense}
        </div>

        ${c.mainEffects ? `<div class="effect">${renderSetEffects("Main", c.mainEffects)}</div>` : ""}
        ${c.factionEffectsLvl1 ? `<div class="effect">${renderSetEffects("Faction", c.factionEffectsLvl1)}</div>` : ""}
        ${c.scrapEffects ? `<div class="effect">${renderSetEffects("Scrap", c.scrapEffects)}</div>` : ""}

        <button onclick="attackStructure('${c.id}', '${c.type}')">Attack ${c.type}</button>


        ${hasScrap ? `
            <button onclick="scrapStructure('${c.id}')">Scrap</button>
        ` : ""}

        ${canDestroyBase ? `
            <button onclick="destroyBase('${c.id}')">Destroy base</button>
        ` : ""}
    </div>
    `;
    }

    function renderSetEffects(title, set) {
        if (!set || !set.effects || set.effects.length === 0) return "";

        return `
        <div class="effect">
            <b>${title} (${set.type})</b>:
            ${set.effects.map(e => `${e.type}+${e.value}`).join(", ")}
        </div>
    `;
    }

    function renderStatus() {
        document.getElementById("status").innerHTML =
            `Status: ${gameView.status}
         ${gameView.winnerId ? "<b> Winner: "+gameView.winnerId+"</b>" : ""}`;
    }

    function renderPlayers() {
        const div = document.getElementById("players");
        div.innerHTML = "";

        gameView.players.forEach(p => {
            div.innerHTML += `
        <div class="${p.active ? "active" : ""}">
            <b>${p.playerId}</b>
            ХП:${p.health}
            АТАКА:${p.currentAttack}
            ЗОЛОТО:${p.currentGold} <br>
            FD:${p.forcedDiscard}
            R.EXILE:${p.rightExile}
            R.DB:${p.destroyBase}
            R.TD:${p.topDeckNextShip}
            R.FREE.TD:${p.buyFreeTopDeck}

            <div>
                <b>Bases</b>
                ${p.bases.map(b => structureView(b, p)).join("")}
            </div>

            <div>
                <b>Outposts</b>
                ${p.outposts.map(o => structureView(o, p)).join("")}
            </div>
        </div>
        `;
        });
    }


    function renderHand() {
        const div = document.getElementById("hand");
        div.innerHTML = "";

        privateView.hand.forEach(c => {

            const hasScrap =
                c.scrapEffects &&
                c.scrapEffects.effects &&
                c.scrapEffects.effects.length > 0;

            const scrapCheckbox = hasScrap ? `
            <label>
                <input type="checkbox" id="scrap-${c.id}">
                scrap
            </label>
        ` : "";

            const factionSelect = c.code === "CORE_MERCENARY" ? `
            <select id="faction-${c.id}">
                <option value="">-- faction --</option>
                <option value="BLOB">BLOB</option>
                <option value="MACHINE_CULT">MACHINE_CULT</option>
                <option value="STAR_EMPIRE">STAR_EMPIRE</option>
                <option value="TRADE_FEDERATION">TRADE_FEDERATION</option>
            </select>
        ` : "";

            div.innerHTML += `
            ${cardView(c)}
            ${factionSelect}
            ${scrapCheckbox}
            <br>
            <button onclick="play('${c.id}')">Play</button>
            <button onclick="exile('${c.id}','${c.code}')">Exile</button>
            ${gameView.players.find(p => p.active)?.forcedDiscard > 0
                ? `<button onclick="forcedDiscard('${c.id}')">Forced discard</button>`
                : ""}
        `;
        });
    }


    function renderPlayed() {
        const div = document.getElementById("played");
        div.innerHTML = "";

        const me = gameView.players.find(p => p.playerId === privateView.playerId);
        if (!me || !me.playedCards) return;

        me.playedCards.forEach(c => {
            div.innerHTML += cardView(c);
        });
    }


    function renderMarket() {
        const div = document.getElementById("market");
        div.innerHTML = "";
        gameView.market.forEach(c => {
            div.innerHTML += `
        ${cardView(c)}
        <label><input type="checkbox" id="top-${c.id}"> top deck</label><br>
        <button onclick="buy('${c.id}')">Buy</button>
        <button onclick="buyFree('${c.id}')">Buy FREE top</button>
        `;
        });
    }

    function renderExplorers() {
        const div = document.getElementById("explorers");
        div.innerHTML = "";
        gameView.explorerPile.forEach(c => {
            div.innerHTML += `
        ${cardView(c)}
        <label><input type="checkbox" id="top-exp-${c.id}"> top deck</label><br>
        <button onclick="buyExplorer('${c.id}')">Buy</button>
        `;
        });
    }

    /* ===== ACTIONS ===== */

    function play(cardId) {
        const factionSelect = document.getElementById("faction-" + cardId);
        const scrapCheckbox = document.getElementById("scrap-" + cardId);

        client.publish({
            destination: "/app/game.playCard",
            body: JSON.stringify({
                gameId,
                cardId,
                scrap: scrapCheckbox ? scrapCheckbox.checked : false,
                faction: factionSelect ? factionSelect.value || null : null
            })
        });
    }

    function buy(id) {
        client.publish({
            destination: "/app/game.buyCard",
            body: JSON.stringify({
                gameId,
                marketCardId:id,
                topDeck: document.getElementById("top-"+id)?.checked ?? false
            })
        });
    }

    function buyExplorer(id) {
        client.publish({
            destination: "/app/game.buyCard",
            body: JSON.stringify({
                gameId,
                marketCardId:id,
                topDeck: document.getElementById("top-exp-"+id)?.checked ?? false
            })
        });
    }

    function buyFree(id) {
        client.publish({
            destination: "/app/game.buyFreeShip",
            body: JSON.stringify({ gameId, marketCardId:id })
        });
    }

    function exile(id,code) {
        client.publish({
            destination: "/app/game.exileCard",
            body: JSON.stringify({ gameId, cardId:id, cardCode:code })
        });
    }

    function forcedDiscard(id) {
        client.publish({
            destination: "/app/game.forcedDiscard",
            body: JSON.stringify({ gameId, cardId:id })
        });
    }

    function attackPlayer() {
        client.publish({
            destination: "/app/game.attack",
            body: JSON.stringify({ gameId, targetType:"PLAYER" })
        });
    }

    function endTurn() {
        client.publish({
            destination: "/app/game.endTurn",
            body: JSON.stringify({ gameId })
        });
    }

    function showError(text) {
        const d = document.getElementById("errors");
        d.innerHTML = `<div class="error">${text}</div>`;
        setTimeout(()=>d.innerHTML="",4000);
    }

    function attackStructure(id, type) {
        client.publish({
            destination: "/app/game.attack",
            body: JSON.stringify({
                gameId,
                targetType: type, // "OUTPOST" | "BASE"
                targetId: id
            })
        });
    }


    function scrapStructure(id) {
        client.publish({
            destination: "/app/game.scrapStructure",
            body: JSON.stringify({
                gameId,
                cardId: id
            })
        });
    }

    function destroyBase(id) {
        client.publish({
            destination: "/app/game.destroyBase",
            body: JSON.stringify({
                gameId,
                BaseId: id
            })
        });
    }

</script>

</body>
</html>
