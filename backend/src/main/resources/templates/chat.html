<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WebSocket UI — SockJS STOMP Client</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <style>
        body {padding-top: 1.5rem}
        #conversation {margin-top: 1rem}
        #statusBadge {min-width: 100px}
        .log-box {height: 180px; overflow:auto; background:#f8f9fa; border:1px solid #e9ecef; padding:0.5rem}
    </style>
</head>

<body>
<div class="container">
    <div class="row align-items-center">
        <div class="col-md-6">
            <h4>WebSocket (SockJS + STOMP)</h4>
            <p class="mb-1">Endpoint: <code>/ws</code></p>
        </div>
        <div class="col-md-6 text-md-right">
            <span id="statusBadge" class="badge badge-secondary">Disconnected</span>
        </div>
    </div>

    <div class="card mt-3">
        <div class="card-body">
            <form class="form-inline" onsubmit="return false;">
                <button id="connect" class="btn btn-primary mr-2" type="button">Connect</button>
                <button id="disconnect" class="btn btn-outline-danger mr-4" type="button" disabled>Disconnect</button>

                <input type="text" id="name" class="form-control mr-2" placeholder="Your message...">

                <button id="send" class="btn btn-success" type="button">Send</button>
            </form>

            <div class="row mt-3">
                <div class="col-md-8">
                    <table id="conversation" class="table table-sm table-striped">
                        <thead>
                        <tr><th>Time</th><th>Message</th></tr>
                        </thead>
                        <tbody id="greetings"></tbody>
                    </table>
                </div>
                <div class="col-md-4">
                    <h6>Logs</h6>
                    <div id="log" class="log-box"></div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Dependencies -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>

<script>
    let stompClient = null;

    function log(msg) {
        const now = new Date().toLocaleTimeString();
        $('#log').append($('<div>').text(now + " — " + msg));
        $('#log').scrollTop($('#log')[0].scrollHeight);
    }

    function setConnected(connected) {
        $("#connect").prop("disabled", connected);
        $("#disconnect").prop("disabled", !connected);

        if (connected) {
            $("#statusBadge").removeClass().addClass("badge badge-success").text("Connected");
        } else {
            $("#statusBadge").removeClass().addClass("badge badge-secondary").text("Disconnected");
        }

        if (!connected) $("#greetings").empty();
    }

    function connect() {
        log("Connecting...");

        const socket = new SockJS("http://localhost:8080/ws");
        stompClient = StompJs.Stomp.over(socket);

        stompClient.reconnectDelay = 5000; // автопереподключение
        stompClient.debug = msg => log("[STOMP] " + msg);

        stompClient.connect({}, frame => {
            log("Connected: " + frame);
            setConnected(true);

            stompClient.subscribe("/topic/chat", message => {
                const body = JSON.parse(message.body);
                showGreeting(body);
            });
        }, error => {
            log("STOMP error: " + error);
        });
    }

    function disconnect() {
        if (stompClient) {
            stompClient.deactivate();
            log("Disconnected");
        }
        setConnected(false);
    }

    function sendMessage() {
        if (!stompClient || !stompClient.connected) {
            log("Not connected");
            return;
        }

        const message = $("#name").val();
        if (!message) return;

        log("Sending: " + message);
        stompClient.send("/app/chat", {}, JSON.stringify({ text: message }));
        $("#name").val("");
    }

    function showGreeting(message) {
        const time = new Date().toLocaleTimeString();
        $("#greetings").append(
            "<tr><td>" + time + "</td><td>" + message.text + "</td></tr>"
        );
    }

    $(function () {
        $("#connect").click(connect);
        $("#disconnect").click(disconnect);
        $("#send").click(sendMessage);
    });
</script>

</body>
</html>
